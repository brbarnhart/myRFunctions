) |>
as_tibble() |>
mutate(
Total_Correct_Pokes = 20 +
4 * (Sex == "M") +
7 * (Diet == "HF") +
5.5 * (Stim == "High") +
3 * (Sex == "M" & Diet == "HF") +
rnorm(n(), sd = 3.2)
)
# Fixed-effects only model
mod_lm <- lm(Total_Correct_Pokes ~ Sex * Diet * Stim, data = dat)
# Mixed model (with random intercept)
mod_lmer <- lmer(Total_Correct_Pokes ~ Sex * Diet * Stim + (1 | ID), data = dat)
# ── NEW: glmmTMB negative binomial model ───────────────────────────────
dat$count <- round(pmax(5, dat$Total_Correct_Pokes))   # make positive integer counts
mod_nb <- glmmTMB::glmmTMB(
count ~ Sex * Diet * Stim + (1 | ID),
family = glmmTMB::nbinom2,
data = dat
)
list(
lm    = mod_lm,
lmer  = mod_lmer,
nb    = mod_nb,          # ← new
data  = dat
)
}
mods <- setup_models()
library(testthat)
library(lme4)
library(lmerTest)     # for p-values and DenDF in anova(lmer)
library(effectsize)
library(dplyr)
library(tibble)
setup_models <- function() {
set.seed(42)
# Balanced small dataset
dat <- expand.grid(
ID   = factor(1:16),
Sex  = factor(c("M", "F")),
Diet = factor(c("Ctrl", "HF")),
Stim = factor(c("Low", "High"))
) |>
as_tibble() |>
mutate(
Total_Correct_Pokes = 20 +
4 * (Sex == "M") +
7 * (Diet == "HF") +
5.5 * (Stim == "High") +
3 * (Sex == "M" & Diet == "HF") +
rnorm(n(), sd = 3.2)
)
# Fixed-effects only model
mod_lm <- lm(Total_Correct_Pokes ~ Sex * Diet * Stim, data = dat)
# Mixed model (with random intercept)
mod_lmer <- lmer(Total_Correct_Pokes ~ Sex * Diet * Stim + (1 | ID), data = dat)
# ── NEW: glmmTMB negative binomial model ───────────────────────────────
dat$count <- round(pmax(5, dat$Total_Correct_Pokes))   # make positive integer counts
mod_nb <- glmmTMB::glmmTMB(
count ~ Sex * Diet * Stim + (1 | ID),
family = glmmTMB::nbinom2,
data = dat
)
list(
lm    = mod_lm,
lmer  = mod_lmer,
nb    = mod_nb,          # ← new
data  = dat
)
}
mods <- setup_models()
model <- mods$lmer
anova(model) |>
as.data.frame()
anova(model) |>
as.data.frame() |>
tibble::rownames_to_column("Effect")
anova(model) |>
as.data.frame() |>
tibble::rownames_to_column("Effect") |>
dplyr::rename(
NumDF    = NumDF,
DenDF    = DenDF,
`F value` = F.value,
`Pr(>F)` = `Pr(>F)`
)
anova(model) |>
as.data.frame() |>
tibble::rownames_to_column("Effect") |>
dplyr::rename(
NumDF    = NumDF,
DenDF    = DenDF,
`F value` = `F value`,
`Pr(>F)` = `Pr(>F)`
)
anova(model) |>
as.data.frame() |>
tibble::rownames_to_column("Effect") |>
dplyr::rename(
NumDF    = NumDF,
DenDF    = DenDF,
`F` = `F value`,
`Pr(>F)` = `Pr(>F)`
)
devtools::load_all()
setup_pairwise_models <- function() {
set.seed(42)
dat <- expand.grid(
ID      = factor(1:20),
Cohort  = factor(1:2),
Sex     = factor(c("M", "F")),
Diet    = factor(c("Ctrl", "HF")),
Stim    = factor(c("Low", "High")),
Satiety = factor(c("Low", "High"))
) |>
as_tibble() |>
mutate(
Total_Correct_Pokes = 15 +
5 * (Sex == "M") +
8 * (Diet == "HF") +
6 * (Stim == "High") +
4 * (Satiety == "High") +
rnorm(n(), sd = 4)
)
# Make counts for glmmTMB
dat$count <- round(pmax(1, dat$Total_Correct_Pokes))
# Gaussian mixed model
mod_lmer <- lmer(Total_Correct_Pokes ~ Sex * Diet * Stim * Satiety + (1 | Cohort/ID),
data = dat)
# glmmTMB negative binomial
mod_nb <- glmmTMB(count ~ Sex * Diet * Stim * Satiety + (1 | Cohort/ID),
family = nbinom2, data = dat)
list(
lmer = mod_lmer,
nb   = mod_nb,
data = dat
)
}
expect_true(all(c("contrast", "Rate Ratio", "RR 95% CI", "% Change") %in% names(tab)))
skip_if_not_installed("glmmTMB")
skip_if_not_installed("emmeans")
mods <- setup_pairwise_models()
# tests/testthat/test-bbmake_pairwise_table.R
library(testthat)
library(lme4)
library(lmerTest)
library(glmmTMB)
library(emmeans)
library(dplyr)
library(tibble)
# ── Helper: create test data and models ─────────────────────────────────────
setup_pairwise_models <- function() {
set.seed(42)
dat <- expand.grid(
ID      = factor(1:20),
Cohort  = factor(1:2),
Sex     = factor(c("M", "F")),
Diet    = factor(c("Ctrl", "HF")),
Stim    = factor(c("Low", "High")),
Satiety = factor(c("Low", "High"))
) |>
as_tibble() |>
mutate(
Total_Correct_Pokes = 15 +
5 * (Sex == "M") +
8 * (Diet == "HF") +
6 * (Stim == "High") +
4 * (Satiety == "High") +
rnorm(n(), sd = 4)
)
# Make counts for glmmTMB
dat$count <- round(pmax(1, dat$Total_Correct_Pokes))
# Gaussian mixed model
mod_lmer <- lmer(Total_Correct_Pokes ~ Sex * Diet * Stim * Satiety + (1 | Cohort/ID),
data = dat)
# glmmTMB negative binomial
mod_nb <- glmmTMB(count ~ Sex * Diet * Stim * Satiety + (1 | Cohort/ID),
family = nbinom2, data = dat)
list(
lmer = mod_lmer,
nb   = mod_nb,
data = dat
)
}
# ==================================================================
# Gaussian models
# ==================================================================
test_that("bbmake_pairwise_table works on Gaussian (lmer) model - Mean Difference + Cohen's d", {
skip_if_not_installed("lmerTest")
skip_if_not_installed("emmeans")
mods <- setup_pairwise_models()
emm <- emmeans(mods$lmer, ~ Sex | Diet, infer = c(TRUE, TRUE))
pw  <- pairs(emm, reverse = TRUE)
tab <- bbmake_pairwise_table(pw, model = mods$lmer)
expect_s3_class(tab, "tbl_df")
expect_true(nrow(tab) >= 1)
expect_true(all(c("contrast", "Mean Difference", "SE", "Cohen's d", "d 95% CI") %in% names(tab)))
expect_true(is.numeric(tab$`Mean Difference`))
expect_true(is.character(tab$`d 95% CI`))
expect_true(all(grepl("^\\[", tab$`d 95% CI`)))  # CI string format
expect_true(all(!is.na(tab$p.value)))
})
library(stringr)
# tests/testthat/test-bbmake_pairwise_table.R
library(testthat)
library(lme4)
library(lmerTest)
library(glmmTMB)
library(emmeans)
library(dplyr)
library(tibble)
# ── Helper: create test data and models ─────────────────────────────────────
setup_pairwise_models <- function() {
set.seed(42)
dat <- expand.grid(
ID      = factor(1:20),
Cohort  = factor(1:2),
Sex     = factor(c("M", "F")),
Diet    = factor(c("Ctrl", "HF")),
Stim    = factor(c("Low", "High")),
Satiety = factor(c("Low", "High"))
) |>
as_tibble() |>
mutate(
Total_Correct_Pokes = 15 +
5 * (Sex == "M") +
8 * (Diet == "HF") +
6 * (Stim == "High") +
4 * (Satiety == "High") +
rnorm(n(), sd = 4)
)
# Make counts for glmmTMB
dat$count <- round(pmax(1, dat$Total_Correct_Pokes))
# Gaussian mixed model
mod_lmer <- lmer(Total_Correct_Pokes ~ Sex * Diet * Stim * Satiety + (1 | Cohort/ID),
data = dat)
# glmmTMB negative binomial
mod_nb <- glmmTMB(count ~ Sex * Diet * Stim * Satiety + (1 | Cohort/ID),
family = nbinom2, data = dat)
list(
lmer = mod_lmer,
nb   = mod_nb,
data = dat
)
}
# ==================================================================
# Gaussian models
# ==================================================================
test_that("bbmake_pairwise_table works on Gaussian (lmer) model - Mean Difference + Cohen's d", {
skip_if_not_installed("lmerTest")
skip_if_not_installed("emmeans")
mods <- setup_pairwise_models()
emm <- emmeans(mods$lmer, ~ Sex | Diet, infer = c(TRUE, TRUE))
pw  <- pairs(emm, reverse = TRUE)
tab <- bbmake_pairwise_table(pw, model = mods$lmer)
expect_s3_class(tab, "tbl_df")
expect_true(nrow(tab) >= 1)
expect_true(all(c("contrast", "Mean Difference", "SE", "Cohen's d", "d 95% CI") %in% names(tab)))
expect_true(is.numeric(tab$`Mean Difference`))
expect_true(is.character(tab$`d 95% CI`))
expect_true(all(grepl("^\\[", tab$`d 95% CI`)))  # CI string format
expect_true(all(!is.na(tab$p.value)))
})
# ==================================================================
# glmmTMB count models - type = "link" and type = "response"
# ==================================================================
test_that("bbmake_pairwise_table works on glmmTMB nbinom2 with type = 'link'", {
skip_if_not_installed("glmmTMB")
skip_if_not_installed("emmeans")
mods <- setup_pairwise_models()
emm <- emmeans(mods$nb, ~ Sex | Diet, type = "link")
pw  <- pairs(emm, reverse = TRUE, infer = TRUE)
tab <- bbmake_pairwise_table(pw)
expect_s3_class(tab, "tbl_df")
expect_true(all(c("contrast", "Rate Ratio", "RR 95% CI", "% Change") %in% names(tab)))
# tests/testthat/test-bbmake_pairwise_table.R
library(testthat)
library(lme4)
library(lmerTest)
library(glmmTMB)
library(emmeans)
library(dplyr)
library(tibble)
library(stringr)
# ── Helper: create test data and models ─────────────────────────────────────
setup_pairwise_models <- function() {
set.seed(42)
dat <- expand.grid(
ID      = factor(1:20),
Cohort  = factor(1:2),
Sex     = factor(c("M", "F")),
Diet    = factor(c("Ctrl", "HF")),
Stim    = factor(c("Low", "High")),
Satiety = factor(c("Low", "High"))
) |>
as_tibble() |>
mutate(
Total_Correct_Pokes = 15 +
5 * (Sex == "M") +
8 * (Diet == "HF") +
6 * (Stim == "High") +
4 * (Satiety == "High") +
rnorm(n(), sd = 4)
)
# Make counts for glmmTMB
dat$count <- round(pmax(1, dat$Total_Correct_Pokes))
# Gaussian mixed model
mod_lmer <- lmer(Total_Correct_Pokes ~ Sex * Diet * Stim * Satiety + (1 | Cohort/ID),
data = dat)
# glmmTMB negative binomial
mod_nb <- glmmTMB(count ~ Sex * Diet * Stim * Satiety + (1 | Cohort/ID),
family = nbinom2, data = dat)
list(
lmer = mod_lmer,
nb   = mod_nb,
data = dat
)
}
# ==================================================================
# Gaussian models
# ==================================================================
test_that("bbmake_pairwise_table works on Gaussian (lmer) model - Mean Difference + Cohen's d", {
skip_if_not_installed("lmerTest")
skip_if_not_installed("emmeans")
mods <- setup_pairwise_models()
emm <- emmeans(mods$lmer, ~ Sex | Diet, infer = c(TRUE, TRUE))
pw  <- pairs(emm, reverse = TRUE)
tab <- bbmake_pairwise_table(pw, model = mods$lmer)
expect_s3_class(tab, "tbl_df")
expect_true(nrow(tab) >= 1)
expect_true(all(c("contrast", "Mean Difference", "SE", "Cohen's d", "d 95% CI") %in% names(tab)))
expect_true(is.numeric(tab$`Mean Difference`))
expect_true(is.character(tab$`d 95% CI`))
expect_true(all(grepl("^\\[", tab$`d 95% CI`)))  # CI string format
expect_true(all(!is.na(tab$p.value)))
})
# ==================================================================
# glmmTMB count models - type = "link" and type = "response"
# ==================================================================
test_that("bbmake_pairwise_table works on glmmTMB nbinom2 with type = 'link'", {
skip_if_not_installed("glmmTMB")
skip_if_not_installed("emmeans")
mods <- setup_pairwise_models()
emm <- emmeans(mods$nb, ~ Sex | Diet, type = "link")
pw  <- pairs(emm, reverse = TRUE, infer = TRUE)
tab <- bbmake_pairwise_table(pw)
expect_s3_class(tab, "tbl_df")
expect_true(all(c("contrast", "Rate Ratio", "RR 95% CI", "% Change") %in% names(tab)))
# tests/testthat/test-bbmake_pairwise_table.R
library(testthat)
library(lme4)
library(lmerTest)
library(glmmTMB)
library(emmeans)
library(dplyr)
library(tibble)
library(stringr)
# ── Helper: create test data and models ─────────────────────────────────────
setup_pairwise_models <- function() {
set.seed(42)
dat <- expand.grid(
ID      = factor(1:20),
Cohort  = factor(1:2),
Sex     = factor(c("M", "F")),
Diet    = factor(c("Ctrl", "HF")),
Stim    = factor(c("Low", "High")),
Satiety = factor(c("Low", "High"))
) |>
as_tibble() |>
mutate(
Total_Correct_Pokes = 15 +
5 * (Sex == "M") +
8 * (Diet == "HF") +
6 * (Stim == "High") +
4 * (Satiety == "High") +
rnorm(n(), sd = 4)
)
# Make counts for glmmTMB
dat$count <- round(pmax(1, dat$Total_Correct_Pokes))
# Gaussian mixed model
mod_lmer <- lmer(Total_Correct_Pokes ~ Sex * Diet * Stim * Satiety + (1 | Cohort/ID),
data = dat)
# glmmTMB negative binomial
mod_nb <- glmmTMB(count ~ Sex * Diet * Stim * Satiety + (1 | Cohort/ID),
family = nbinom2, data = dat)
list(
lmer = mod_lmer,
nb   = mod_nb,
data = dat
)
}
# ==================================================================
# Gaussian models
# ==================================================================
test_that("bbmake_pairwise_table works on Gaussian (lmer) model - Mean Difference + Cohen's d", {
skip_if_not_installed("lmerTest")
skip_if_not_installed("emmeans")
mods <- setup_pairwise_models()
emm <- emmeans(mods$lmer, ~ Sex | Diet, infer = c(TRUE, TRUE))
pw  <- pairs(emm, reverse = TRUE)
tab <- bbmake_pairwise_table(pw, model = mods$lmer)
expect_s3_class(tab, "tbl_df")
expect_true(nrow(tab) >= 1)
expect_true(all(c("contrast", "Mean Difference", "SE", "Cohen's d", "d 95% CI") %in% names(tab)))
expect_true(is.numeric(tab$`Mean Difference`))
expect_true(is.character(tab$`d 95% CI`))
expect_true(all(grepl("^\\[", tab$`d 95% CI`)))  # CI string format
expect_true(all(!is.na(tab$p.value)))
})
# ==================================================================
# glmmTMB count models - type = "link" and type = "response"
# ==================================================================
test_that("bbmake_pairwise_table works on glmmTMB nbinom2 with type = 'link'", {
skip_if_not_installed("glmmTMB")
skip_if_not_installed("emmeans")
mods <- setup_pairwise_models()
emm <- emmeans(mods$nb, ~ Sex | Diet, type = "link")
pw  <- pairs(emm, reverse = TRUE, infer = TRUE)
tab <- bbmake_pairwise_table(pw)
expect_s3_class(tab, "tbl_df")
expect_true(all(c("contrast", "Rate Ratio", "RR 95% CI", "% Change") %in% names(tab)))
expect_true(is.numeric(tab$`Rate Ratio`))
expect_true(is.character(tab$`RR 95% CI`))
expect_true(all(grepl("^\\[", tab$`RR 95% CI`)))
expect_true(all(grepl("%$", tab$`% Change`)))
})
c("contrast", "Rate Ratio", "RR 95% CI", "% Change") %in% names(tab)
mods <- setup_pairwise_models()
emm <- emmeans(mods$nb, ~ Sex | Diet, type = "link")
pw  <- pairs(emm, reverse = TRUE, infer = TRUE)
tab <- bbmake_pairwise_table(pw
expect_true(all(c("contrast", "Rate Ratio", "RR 95% CI", "% Change") %in% names(tab)))
expect_true(all(c("contrast", "Rate Ratio", "RR 95% CI", "% Change") %in% names(tab)))
tab <- bbmake_pairwise_table(pw)
expect_true(all(c("contrast", "Rate Ratio", "RR 95% CI", "% Change") %in% names(tab)))
c("contrast", "Rate Ratio", "RR 95% CI", "% Change") %in% names(tab)
tab
devtools::load_all()
testthat::test_file("tests/testthat/test-bbmake_pairwise_table.R")
devtools::load_all()
testthat::test_file("tests/testthat/test-bbmake_pairwise_table.R")
library(testthat)
library(lme4)
library(lmerTest)
library(glmmTMB)
library(emmeans)
library(dplyr)
library(tibble)
# ── Helper: create test data and models (warnings suppressed) ─────────────────
setup_pairwise_models <- function() {
set.seed(42)
dat <- expand.grid(
ID      = factor(1:20),
Cohort  = factor(1:2),
Sex     = factor(c("M", "F")),
Diet    = factor(c("Ctrl", "HF")),
Stim    = factor(c("Low", "High")),
Satiety = factor(c("Low", "High"))
) |>
as_tibble() |>
mutate(
Total_Correct_Pokes = 15 +
5 * (Sex == "M") +
8 * (Diet == "HF") +
6 * (Stim == "High") +
4 * (Satiety == "High") +
rnorm(n(), sd = 4)
)
dat$count <- round(pmax(1, dat$Total_Correct_Pokes))
# Suppress the common Hessian warning from small glmmTMB data
mod_lmer <- suppressWarnings(
lmer(Total_Correct_Pokes ~ Sex * Diet * Stim * Satiety + (1 | Cohort/ID),
data = dat)
)
mod_nb <- suppressWarnings(
glmmTMB(count ~ Sex * Diet * Stim * Satiety + (1 | Cohort/ID),
family = nbinom2, data = dat)
)
list(lmer = mod_lmer, nb = mod_nb, data = dat)
}
mods <- setup_pairwise_models()
emm <- emmeans(mods$nb, ~ Sex | Diet, type = "response")
pw  <- pairs(emm, reverse = TRUE, infer = TRUE)
tab <- bbmake_pairwise_table(pw)
# polishing checks
expect_true(all(str_trim(tab$contrast) == tab$contrast),
info = "contrast column should have no leading/trailing whitespace")
unsorted_p <- na.omit(tab$p.value)
expect_true(!is.unsorted(unsorted_p),
info = paste("p.value not sorted ascending. First few p-values:",
paste(head(unsorted_p, 6), collapse = ", ")))
# nice table should not error
expect_no_error({
ft <- bbnice_pairwise_table(tab, title = "Test Pairwise")
expect_s3_class(ft, "flextable")
})
expect_s3_class(ft, "flextable")
ft <- bbnice_pairwise_table(tab, title = "Test Pairwise")
expect_s3_class(ft, "flextable")
ft
tab
pw
emm
mods
emm <- emmeans(mods$nb, ~ Sex * Diet, type = "response")
pw  <- pairs(emm, reverse = TRUE, infer = TRUE)
emm
pw
tab <- bbmake_pairwise_table(pw)
tab
bbnice_pairwise_table(tab, title = "Test Pairwise")
